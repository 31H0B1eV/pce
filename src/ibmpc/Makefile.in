# Makefile
# $Id: Makefile.in,v 1.11 2003/09/02 11:44:47 hampa Exp $

srcdir := @srcdir@
topdir := @top_srcdir@
subdir := bios
reldir := ../..
pcesrc	:= $(topdir)/src
pcedst	:= ..

include $(reldir)/Makefile.inc


FILES	:= cga disk hgc hook ibmpc log mda memory mouse \
	parport pce video xms

SRC	:= $(foreach f,$(FILES),$(f).c)

OBJ	:= $(foreach f,$(FILES),$(f).o)

OBJ_EXT	:= \
	$(pcedst)/e8086/e8086.a $(pcedst)/chipset/chipset.a \
	$(pcedst)/libini/libini.a \
	$(pcedst)/terminal/terminal.o $(pcedst)/terminal/vt100.o

HDR	:= $(foreach f,$(FILES),$(f).h)

HDR_EXT	:= \
	$(pcesrc)/e8086/e8086.h $(pcesrc)/chipset/e8253.h \
	$(pcesrc)/chipset/e8255.h $(pcesrc)/chipset/e8259.h \
	$(pcesrc)/libini/libini.h \
	$(pcesrc)/terminal/terminal.h $(pcesrc)/terminal/vt100.h

MAN	:=

BIN	:= pce

ifeq "$(PCE_X11_USE)" "1"
	OBJ_EXT += $(pcedst)/terminal/x11.o
	HDR_EXT += $(pcesrc)/terminal/x11.h
	CC_FLG_EXTRA := $(PCE_X11_CCF)
	LD_FLG_EXTRA := $(PCE_X11_LDF)
endif

SDP	:= Makefile $(HDR) $(HDR_EXT)
BDP	:= Makefile $(OBJ) $(OBJ_EXT)


all: $(BIN) $(OBJ) pce.cfg


clean:
	rm -f $(OBJ) $(BIN)


install:
	$(INSTALL) -d -m 755 $(bindir)
	$(INSTALL) -d -m 755 $(etcdir)
	$(INSTALL) -m 755 -s $(BIN) $(bindir)
	test -f $(etcdir)/pce.cfg || $(INSTALL) -m 644 pce.cfg $(etcdir)
ifneq "$(MAN)" ""
	$(INSTALL) -d -m 755 $(mandir)/man1
	for f in $(MAN) ; do \
		rm -f $(mandir)/man1/$$f.gz ; \
		gzip -c --best $(srcdir)/$$f > $(mandir)/man1/$$f.gz ; \
	done
endif


pce: $(OBJ) $(OBJ_EXT)
	$(LD) $(LD_FLG) $(LD_FLG_EXTRA) -o $@ $(OBJ) $(OBJ_EXT) -L/usr/X11R6/lib -lX11

pce.cfg: pce.cfg.in
	sed -e "s]PCE_DIR_DATA]$(datdir)]g" < $< > $@


cga.o:		cga.c $(SDP)
disk.o:		disk.c $(SDP)
hgc.o:		hgc.c $(SDP)
hook.o:		hook.c $(SDP)
ibmpc.o:	ibmpc.c $(SDP)
log.o:		log.c $(SDP)
mda.o:		mda.c $(SDP)
memory.o:	memory.c $(SDP)
mouse.o:	mouse.c $(SDP)
parport.o:	parport.c $(SDP)
pce.o:		pce.c $(SDP)
video.o:	video.c $(SDP)
xms.o:		xms.c $(SDP)
