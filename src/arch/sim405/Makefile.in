# Makefile
# $Id$

srcdir := @srcdir@
topdir := @top_srcdir@
subdir :=
reldir := ../../..

pcesrc := $(topdir)/src
pcedst := $(reldir)/src


include $(reldir)/config.inc


CC_FLG += -I$(srcdir)


FILES := cmd_ppc main pci sim405 sercons

SRC := $(foreach f,$(FILES),$(f).c)
OBJ := $(foreach f,$(FILES),$(f).o)
HDR := $(foreach f,$(FILES),$(f).h)

OBJ_EXT	:= \
	$(pcedst)/cpu/ppc405/ppc405.a \
	$(pcedst)/chipset/82xx/e8250.o \
	$(pcedst)/chipset/ppc405/uic.o \
	$(pcedst)/devices/ata.o \
	$(pcedst)/devices/memory.o \
	$(pcedst)/devices/nvram.o \
	$(pcedst)/devices/pci.o \
	$(pcedst)/devices/pci-ata.o \
	$(pcedst)/devices/serport.o \
	$(pcedst)/devices/slip.o \
	$(pcedst)/lib/brkpt.o \
	$(pcedst)/lib/cmd.o \
	$(pcedst)/lib/hexdump.o \
	$(pcedst)/lib/ihex.o \
	$(pcedst)/lib/srec.o \
	$(pcedst)/lib/inidsk.o \
	$(pcedst)/lib/load.o \
	$(pcedst)/lib/log.o \
	$(PCE_BLK_OBJ) \
	$(pcedst)/libini/libini.a


HDR_EXT	:= \
	$(pcedst)/config.h \
	cpu/ppc405/ppc405.h \
	chipset/82xx/e8250.h \
	chipset/ppc405/uic.h \
	devices/ata.h \
	devices/pci.h \
	devices/pci-ata.h \
	devices/memory.h \
	devices/nvram.h \
	devices/serport.h \
	devices/slip.h \
	lib/brkpt.h \
	lib/cmd.h \
	lib/hexdump.h \
	lib/ihex.h \
	lib/srec.h \
	lib/inidsk.h \
	lib/load.h \
	lib/log.h \
	$(PCE_BLK_HDR) \
	libini/libini.h

MAN1	:=

BIN	:= sim405

ifeq "$(PCE_ENABLE_TUN)" "1"
OBJ_EXT += $(pcedst)/lib/tun.o
HDR_EXT += lib/tun.h
endif

SDP	:= Makefile $(HDR) $(HDR_EXT)
BDP	:= Makefile $(OBJ) $(OBJ_EXT)

CLN := $(BIN) $(OBJ) sim405.cfg
DCL := Makefile


include $(reldir)/rules.inc


all: $(BIN) $(OBJ) sim405.cfg


install: install-bin sim405.cfg
	$(QR)$(INSTALL) -d -m 755 $(DESTDIR)$(etcdir)
	$(QP)echo "  CP     sim405.cfg"
	$(QR)test -f $(DESTDIR)$(etcdir)/sim405.cfg || $(INSTALL) -m 644 sim405.cfg $(DESTDIR)$(etcdir)


sim405: $(OBJ) $(OBJ_EXT)
	$(QP)echo "  LD     $@"
	$(QR)$(LD) $(LD_FLG) -o $@ $(OBJ) $(OBJ_EXT) $(LD_FLG_EXTRA)


sim405.cfg: sim405.cfg.in
	$(QP)echo "  SED    $@"
	$(QR)sed -e "s]PCE_DIR_DATA]$(datdir)]g" < $< > $@


cmd_ppc.o:	cmd_ppc.c $(SDP)
sim405.o:	sim405.c $(SDP)
main.o:		main.c $(SDP)
pci.o:		pci.c $(SDP)
sercons.o:	sercons.c $(SDP)
