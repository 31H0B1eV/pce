# Makefile
# $Id$

srcdir := @srcdir@
topdir := @top_srcdir@
subdir :=
reldir := ../../../..


include $(reldir)/config.inc


SRC := basic.asm bios.asm ega.asm pce.asm vga.asm
OBJ := basic.bin bios.bin ega.bin pce.bin pce2.bin vga.bin
LST := basic.lst bios.lst ega.lst pce.lst vga.lst
HDR :=
MAN :=
BIN := pce-ega.rom pce-bios.rom pce-vga.rom
HEX := pce-ega.ihex pce-bios.ihex pce-bios-ega.ihex

HDR_EXT	:= $(topdir)/src/arch/ibmpc/pce.inc

SDP := Makefile $(HDR) $(HDR_EXT)
BDP := Makefile $(OBJ) $(OBJ_EXT)


BIOS_OBJ := basic.bin bios.bin pce.bin
BIOS_SDP := Makefile $(HDR) $(HDR_EXT)
BIOS_BDP := Makefile $(BIOS_OBJ)

EGA_OBJ := ega.bin
EGA_SDP := Makefile fnt8x8.inc fnt8x14.inc $(HDR) $(HDR_EXT)
EGA_BDP := Makefile $(EGA_OBJ)

VGA_OBJ := vga.bin
VGA_SDP := Makefile fnt8x8.inc fnt8x14.inc fnt8x16.inc pal13.inc $(HDR) $(HDR_EXT)
VGA_BDP := Makefile $(VGA_OBJ)

CLN := $(OBJ) $(BIN) $(LST) $(HEX)
DCL := Makefile

DIST := $(SRC) $(HDR) fnt8x8.inc fnt8x14.inc fnt8x16.inc pal13.inc Makefile.in


include $(reldir)/rules.inc


TARGET := $(BIN)

ifeq "$(PCE_HAVE_IHEX)" "1"
TARGET += $(HEX)
endif


NFLAGS += -I$(srcdir)/ -I$(reldir)/src/ -I$(topdir)/src/arch/ibmpc/


all: $(TARGET)


install:
	$(QR)$(INSTALL) -d -m 755 $(DESTDIR)$(datdir)
	$(QR)for f in $(BIN) ; do \
		test x$(V) != x1 && echo "  CP     $$f" ; \
		$(INSTALL) -m 644 $$f $(DESTDIR)$(datdir) ; \
	done


dist:
	$(QR)for f in $(BIN) ; do \
		test -f "$$f" || continue ; \
		test x$(V) != x1 && echo "  CP     $$f" ; \
		mkdir -p "$(distbase)/contrib/rom/ibmpc" ; \
		cp -p "$$f" "$(distbase)/contrib/rom/ibmpc" ; \
	done


cmp:
	bdiff -E -b 65536 -i $(srcdir)/ibmpc.cmp -i ibmpc.rom > ibmpc.diff


pce-ega.rom: $(EGA_BDP)
	$(QP)echo "  CAT    $@"
	$(QR)cat ega.bin > $@

pce-vga.rom: $(VGA_BDP)
	$(QP)echo "  CAT    $@"
	$(QR)cat vga.bin > $@

pce-bios.rom: $(BIOS_BDP)
	$(QP)echo "  CAT    $@"
	$(QR)cat pce.bin basic.bin bios.bin > $@


pce-bios.ihex: pce2.bin basic.bin bios.bin
	$(QP)echo "  IHEX   $@"
	$(QR)$(IHEX) -e -o $@ \
	-s 0xf000 -a 0 -i pce2.bin \
	-s 0xf600 -a 0 -i basic.bin \
	-s 0xfe00 -a 0 -i bios.bin

pce-bios-ega.ihex: ega.bin pce2.bin basic.bin bios.bin
	$(QP)echo "  IHEX   $@"
	$(QR)$(IHEX) -e -o $@ \
	-s 0xc000 -a 0 -i ega.bin \
	-s 0xf000 -a 0 -i pce2.bin \
	-s 0xf600 -a 0 -i basic.bin \
	-s 0xfe00 -a 0 -i bios.bin

pce-ega.ihex: ega.bin
	$(QP)echo "  IHEX   $@"
	$(QR)$(IHEX) -e -o $@ -s 0xc000 -a 0 -i ega.bin


pce.bin: pce.asm $(BIOS_SDP)
	$(QP)echo "  NASM   $@"
	$(QR)$(NASM) $(NFLAGS) -O6 -f bin -l pce.lst -o $@ $<

pce2.bin: pce.asm $(BIOS_SDP)
	$(QP)echo "  NASM   $@"
	$(QR)$(NASM) $(NFLAGS) -DNOFILL -O6 -f bin -l pce.lst -o $@ $<

bios.bin: bios.asm $(BIOS_SDP)
	$(QP)echo "  NASM   $@"
	$(QR)$(NASM) $(NFLAGS) -DPATCH -f bin -l bios.lst -o $@ $<

basic.bin: basic.asm $(BIOS_SDP)
	$(QP)echo "  NASM   $@"
	$(QR)$(NASM) $(NFLAGS) -f bin -l basic.lst -o $@ $<

ega.bin: ega.asm $(EGA_SDP)
	$(QP)echo "  NASM   $@"
	$(QR)$(NASM) $(NFLAGS) -O6 -f bin -l ega.lst -o $@ $<

vga.bin: vga.asm $(VGA_SDP)
	$(QP)echo "  NASM   $@"
	$(QR)$(NASM) $(NFLAGS) -O6 -f bin -l vga.lst -o $@ $<
