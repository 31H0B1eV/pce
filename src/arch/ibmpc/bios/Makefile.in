# Makefile
# $Id$

srcdir := @srcdir@
topdir := @top_srcdir@
subdir :=
reldir := ../../../..


include $(reldir)/config.inc


SRC := basic.asm bios.asm ega.asm pce.asm vga.asm
OBJ := basic.bin bios.bin ega.bin pce.bin vga.bin
LST := basic.lst bios.lst ega.lst pce.lst vga.lst
HDR :=
MAN :=
BIN := ega.rom ibmpc.rom vga.rom

HDR_EXT	:= $(topdir)/src/arch/ibmpc/pce.inc

SDP := Makefile $(HDR) $(HDR_EXT)
BDP := Makefile $(OBJ) $(OBJ_EXT)


BIOS_OBJ := basic.bin bios.bin pce.bin
BIOS_SDP := Makefile $(HDR) $(HDR_EXT)
BIOS_BDP := Makefile $(BIOS_OBJ)

EGA_OBJ := ega.bin
EGA_SDP := Makefile fnt8x8.inc fnt8x14.inc $(HDR) $(HDR_EXT)
EGA_BDP := Makefile $(EGA_OBJ)

VGA_OBJ := vga.bin
VGA_SDP := Makefile fnt8x8.inc fnt8x14.inc fnt8x16.inc pal13.inc $(HDR) $(HDR_EXT)
VGA_BDP := Makefile $(VGA_OBJ)

CLN := $(OBJ) $(BIN) $(LST)
DCL := Makefile


include $(reldir)/rules.inc


TARGET := $(BIN)

ifeq "$(PCE_HAVE_IHEX)" "1"
TARGET += ihex
endif


all: $(TARGET)


install:
	$(QR)$(INSTALL) -d -m 755 $(DESTDIR)$(datdir)
	$(QR)for f in $(BIN) ; do \
		if test x$(V) != x1 ; then echo "  CP     $$f" ; fi ; \
		$(INSTALL) -m 644 $$f $(DESTDIR)$(datdir) ; \
	done


cmp:
	bdiff -E -b 65536 -i $(srcdir)/ibmpc.cmp -i ibmpc.rom > ibmpc.diff


ega.rom: $(EGA_BDP)
	$(QP)echo "  CAT    $@"
	$(QR)cat ega.bin > $@

vga.rom: $(VGA_BDP)
	$(QP)echo "  CAT    $@"
	$(QR)cat vga.bin > $@

ibmpc.rom: $(BIOS_BDP)
	$(QP)echo "  CAT    $@"
	$(QR)cat pce.bin basic.bin bios.bin > $@


# ihex is a custom utility, part of the misc-utils package
ihex: ibmpc.ihex ibmpc-ega.ihex ega.ihex

ibmpc.ihex: pce2.bin basic.bin bios.bin
	$(QP)echo "  IHEX   $@"
	$(QR)$(IHEX) -e -o $@ \
	-a 0xf0000 -i pce2.bin \
	-a 0xf6000 -i basic.bin \
	-a 0xfe000 -i bios.bin

ibmpc-ega.ihex: ega.bin pce2.bin basic.bin bios.bin
	$(QP)echo "  IHEX   $@"
	$(QR)$(IHEX) -e -o $@ \
	-a 0xc0000 -i ega.bin \
	-a 0xf0000 -i pce2.bin \
	-a 0xf6000 -i basic.bin \
	-a 0xfe000 -i bios.bin

ega.ihex: ega.bin
	$(QP)echo "  IHEX   $@"
	$(QR)$(IHEX) -e -o $@ -a 0xc0000 -i ega.bin


pce.bin: pce.asm $(BIOS_SDP)
	$(QP)echo "  NASM   $@"
	$(QR)$(NASM) -I$(reldir)/src/ -I$(topdir)/src/arch/ibmpc/ -f bin -l pce.lst -o $@ $<

pce2.bin: pce.asm $(BIOS_SDP)
	$(QP)echo "  NASM   $@"
	$(QR)$(NASM) -I$(reldir)/src/ -I$(topdir)/src/arch/ibmpc/ -f bin -l pce.lst -DNOFILL -o $@ $<

bios.bin: bios.asm $(BIOS_SDP)
	$(QP)echo "  NASM   $@"
	$(QR)$(NASM) -I$(reldir)/src/ -I$(topdir)/src/arch/ibmpc/ -f bin -l bios.lst -o $@ $<

basic.bin: basic.asm $(BIOS_SDP)
	$(QP)echo "  NASM   $@"
	$(QR)$(NASM) -I$(reldir)/src/ -I$(topdir)/src/arch/ibmpc/ -f bin -l basic.lst -o $@ $<

ega.bin: ega.asm $(EGA_SDP)
	$(QP)echo "  NASM   $@"
	$(QR)$(NASM) -O2 -I$(srcdir)/ -I$(reldir)/src/ -I$(topdir)/src/arch/ibmpc/ -f bin -l ega.lst -o $@ $<

vga.bin: vga.asm $(VGA_SDP)
	$(QP)echo "  NASM   $@"
	$(QR)$(NASM) -O2 -I$(srcdir)/ -I$(reldir)/src/ -I$(topdir)/src/arch/ibmpc/ -f bin -l vga.lst -o $@ $<
