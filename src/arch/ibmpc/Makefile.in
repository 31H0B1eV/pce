# Makefile
# $Id: Makefile.in,v 1.1 2003/12/20 01:01:33 hampa Exp $

srcdir := @srcdir@
topdir := @top_srcdir@
subdir :=
reldir := ../../..

ifeq "@PCE_HAVE_NASM@" "1"
subdir += bios pceutils
endif


include $(reldir)/Makefile.inc


FILES := \
	disk ems hook ibmpc mouse parport pce serial xms

SRC	:= $(foreach f,$(FILES),$(f).c)

OBJ	:= $(foreach f,$(FILES),$(f).o)

OBJ_EXT	:= \
	$(pcedst)/cpu/e8086/e8086.a \
	$(pcedst)/chipset/chipset.a \
	$(pcedst)/devices/cga.o \
	$(pcedst)/devices/ega.o \
	$(pcedst)/devices/hgc.o \
	$(pcedst)/devices/mda.o \
	$(pcedst)/devices/memory.o \
	$(pcedst)/devices/video.o \
	$(pcedst)/lib/cmd.o \
	$(pcedst)/lib/hexdump.o \
	$(pcedst)/lib/log.o \
	$(pcedst)/libini/libini.a \
	$(pcedst)/terminal/terminal.a

HDR	:= $(foreach f,$(FILES),$(f).h)

HDR_EXT	:= \
	$(pcedst)/config.h \
	cpu/e8086/e8086.h \
	chipset/e8253.h \
	chipset/e8255.h \
	chipset/e8259.h \
	devices/cga.h \
	devices/ega.h \
	devices/hgc.h \
	devices/mda.h \
	devices/memory.h \
	devices/video.h \
	lib/cmd.h \
	lib/hexdump.h \
	lib/log.h \
	libini/libini.h \
	terminal/terminal.h \
	terminal/vt100.h \
	terminal/null.h \
	terminal/font.h

MAN1	:= pce.1

BIN	:= pce

ifeq "$(PCE_X11_USE)" "1"
	HDR_EXT += terminal/x11.h
	CC_FLG_EXTRA += $(PCE_X11_CCF)
	LD_FLG_EXTRA += $(PCE_X11_LDF)
endif

ifeq "$(PCE_SDL_USE)" "1"
	HDR_EXT += terminal/sdl.h
	CC_FLG_EXTRA += $(PCE_SDL_CCF)
	LD_FLG_EXTRA += $(PCE_SDL_LDF)
endif


SDP	:= Makefile $(HDR) $(HDR_EXT)
BDP	:= Makefile $(OBJ) $(OBJ_EXT)


all: $(BIN) $(OBJ) pce.cfg


clean:
	rm -f $(OBJ) $(BIN)


install: pce pce.cfg
	$(INSTALL) -d -m 755 $(bindir)
	$(INSTALL) -d -m 755 $(etcdir)
	$(INSTALL) -m 755 -s $(BIN) $(bindir)
	test -f $(etcdir)/pce.cfg || $(INSTALL) -m 644 pce.cfg $(etcdir)
ifneq "$(MAN1)" ""
	$(INSTALL) -d -m 755 $(mandir)/man1
	for f in $(MAN1) ; do \
		rm -f $(mandir)/man1/$$f.gz ; \
		gzip -c --best $(srcdir)/$$f > $(mandir)/man1/$$f.gz ; \
	done
endif


pce: $(OBJ) $(OBJ_EXT)
	$(LD) $(LD_FLG) -o $@ $(OBJ) $(OBJ_EXT) $(LD_FLG_EXTRA)

pce.cfg: pce.cfg.in
	sed -e "s]PCE_DIR_DATA]$(datdir)]g" < $< > $@


disk.o:		disk.c $(SDP)
ems.o:		ems.c $(SDP)
hook.o:		hook.c $(SDP)
ibmpc.o:	ibmpc.c $(SDP)
mouse.o:	mouse.c $(SDP)
parport.o:	parport.c $(SDP)
pce.o:		pce.c $(SDP)
serial.o:	serial.c $(SDP)
xms.o:		xms.c $(SDP)
