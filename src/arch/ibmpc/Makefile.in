# Makefile
# $Id$

srcdir := @srcdir@
topdir := @top_srcdir@
subdir :=
reldir := ../../..

pcesrc := $(topdir)/src
pcedst := $(reldir)/src


include $(reldir)/config.inc


ifeq "@PCE_HAVE_NASM@" "1"
subdir += bios pceutils
endif


FILES := ems hook ibmpc int13 main mouse msg util xms

SRC := $(foreach f,$(FILES),$(f).c)
OBJ := $(foreach f,$(FILES),$(f).o)
HDR := $(foreach f,$(FILES),$(f).h)

OBJ_EXT	:= \
	$(pcedst)/cpu/e8086/e8086.a \
	$(pcedst)/chipset/82xx/chipset.a \
	$(pcedst)/devices/video/cga.o \
	$(pcedst)/devices/video/vga.o \
	$(pcedst)/devices/video/ega.o \
	$(pcedst)/devices/video/hgc.o \
	$(pcedst)/devices/video/mda.o \
	$(pcedst)/devices/video/video.o \
	$(pcedst)/devices/device.o \
	$(pcedst)/devices/memory.o \
	$(pcedst)/devices/nvram.o \
	$(pcedst)/devices/parport.o \
	$(pcedst)/devices/serport.o \
	$(pcedst)/lib/brkpt.o \
	$(pcedst)/lib/cmd.o \
	$(pcedst)/lib/console.o \
	$(pcedst)/lib/hexdump.o \
	$(pcedst)/lib/inidsk.o \
	$(pcedst)/lib/iniram.o \
	$(pcedst)/lib/ihex.o \
	$(pcedst)/lib/srec.o \
	$(pcedst)/lib/load.o \
	$(pcedst)/lib/log.o \
	$(pcedst)/lib/monitor.o \
	$(pcedst)/lib/msg.o \
	$(pcedst)/lib/sysdep.o \
	$(pcedst)/libini/libini.a \
	$(PCE_BLK_OBJ) \
	$(PCE_TERM_OBJ)

HDR_EXT	:= \
	$(pcedst)/config.h \
	cpu/e8086/e8086.h \
	chipset/82xx/e8237.h \
	chipset/82xx/e8250.h \
	chipset/82xx/e8253.h \
	chipset/82xx/e8255.h \
	chipset/82xx/e8259.h \
	$(PCE_BLK_HDR) \
	devices/video/cga.h \
	devices/video/vga.h \
	devices/video/ega.h \
	devices/video/hgc.h \
	devices/video/mda.h \
	devices/video/video.h \
	devices/device.h \
	devices/memory.h \
	devices/nvram.h \
	devices/parport.h \
	devices/serport.h \
	lib/brkpt.h \
	lib/cmd.h \
	lib/console.h \
	lib/hexdump.h \
	lib/inidsk.h \
	lib/iniram.h \
	lib/ihex.h \
	lib/srec.h \
	lib/load.h \
	lib/log.h \
	lib/monitor.h \
	lib/msg.h \
	lib/sysdep.h \
	libini/libini.h \
	$(PCE_TERM_HDR)

ifeq "$(PCE_X11_USE)" "1"
	HDR_EXT += terminal/x11.h
	CC_FLG_EXTRA += $(PCE_X11_CCF)
	LD_FLG_EXTRA += $(PCE_X11_LDF)
endif

ifeq "$(PCE_SDL_USE)" "1"
	HDR_EXT += terminal/sdl.h
	CC_FLG_EXTRA += $(PCE_SDL_CCF)
	LD_FLG_EXTRA += $(PCE_SDL_LDF)
endif

MAN1 := pce-ibmpc.1
MANT := $(foreach f,$(MAN1),$(f).txt $(f).ps)
BIN  := pce-ibmpc

SDP := Makefile $(HDR) $(HDR_EXT)
BDP := Makefile $(OBJ) $(OBJ_EXT)

CLN := $(OBJ) $(BIN) $(MANT) pce-ibmpc.cfg
DCL := Makefile


include $(reldir)/rules.inc


all: $(BIN) $(OBJ) pce-ibmpc.cfg


install: pce-ibmpc pce-ibmpc.cfg install-bin install-man
	$(QP)echo "  LN     pce"
	$(QR)( rm -f $(DESTDIR)$(bindir)/pce ; \
		cd $(DESTDIR)$(bindir) && ln -s pce-ibmpc pce ; )
	$(QR)$(INSTALL) -d -m 755 $(DESTDIR)$(etcdir)
	$(QP)echo "  CP     pce-ibmpc.cfg"
	$(QR)test -f $(DESTDIR)$(etcdir)/pce-ibmpc.cfg || \
		$(INSTALL) -m 644 pce-ibmpc.cfg $(DESTDIR)$(etcdir)


pce-ibmpc: $(OBJ) $(OBJ_EXT)
	$(QP)echo "  LD     $@"
	$(QR)$(LD) $(LD_FLG) -o $@ $(OBJ) $(OBJ_EXT) $(LD_FLG_EXTRA)


pce-ibmpc.cfg: ibmpc.cfg.in
	$(QP)echo "  SED    $@"
	$(QR)sed -e "s]PCE_DIR_DATA]$(datdir)]g" < $< > $@


int13.o:	int13.c $(SDP)
ems.o:		ems.c $(SDP)
hook.o:		hook.c $(SDP)
ibmpc.o:	ibmpc.c $(SDP)
main.o:		main.c $(SDP)
mouse.o:	mouse.c $(SDP)
msg.o:		msg.c $(SDP)
util.o:		util.c $(SDP)
xms.o:		xms.c $(SDP)
