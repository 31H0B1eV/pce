# Makefile
# $Id$

srcdir := @srcdir@
topdir := @top_srcdir@
subdir :=
reldir := ../../..

pcesrc := $(topdir)/src
pcedst := $(reldir)/src


include $(reldir)/config.inc


ifeq "@PCE_HAVE_NASM@" "1"
subdir += bios pceutils
endif


FILES := ems hook ibmpc int13 mouse parport pce xms

SRC := $(foreach f,$(FILES),$(f).c)
OBJ := $(foreach f,$(FILES),$(f).o)
HDR := $(foreach f,$(FILES),$(f).h)

OBJ_EXT	:= \
	$(pcedst)/cpu/e8086/e8086.a \
	$(pcedst)/chipset/chipset.a \
	$(pcedst)/devices/cga.o \
	$(pcedst)/devices/disk.o \
	$(pcedst)/devices/ega.o \
	$(pcedst)/devices/hgc.o \
	$(pcedst)/devices/mda.o \
	$(pcedst)/devices/memory.o \
	$(pcedst)/devices/nvram.o \
	$(pcedst)/devices/serial.o \
	$(pcedst)/devices/video.o \
	$(pcedst)/lib/cmd.o \
	$(pcedst)/lib/hexdump.o \
	$(pcedst)/lib/log.o \
	$(pcedst)/libini/libini.a \
	$(pcedst)/terminal/terminal.a

HDR_EXT	:= \
	$(pcedst)/config.h \
	cpu/e8086/e8086.h \
	chipset/e8253.h \
	chipset/e8255.h \
	chipset/e8259.h \
	devices/cga.h \
	devices/disk.h \
	devices/ega.h \
	devices/hgc.h \
	devices/mda.h \
	devices/memory.h \
	devices/nvram.h \
	devices/serial.h \
	devices/video.h \
	lib/cmd.h \
	lib/hexdump.h \
	lib/log.h \
	libini/libini.h \
	terminal/terminal.h \
	terminal/vt100.h \
	terminal/null.h \
	terminal/font.h

ifeq "$(PCE_X11_USE)" "1"
	HDR_EXT += terminal/x11.h
	CC_FLG_EXTRA += $(PCE_X11_CCF)
	LD_FLG_EXTRA += $(PCE_X11_LDF)
endif

ifeq "$(PCE_SDL_USE)" "1"
	HDR_EXT += terminal/sdl.h
	CC_FLG_EXTRA += $(PCE_SDL_CCF)
	LD_FLG_EXTRA += $(PCE_SDL_LDF)
endif

MAN1 := pce.1
BIN  := pce

SDP := Makefile $(HDR) $(HDR_EXT)
BDP := Makefile $(OBJ) $(OBJ_EXT)

CLN := $(OBJ) $(BIN) pce.cfg
DCL := Makefile


include $(reldir)/rules.inc


all: $(BIN) $(OBJ) pce.cfg


install: pce pce.cfg install-bin install-man
	$(INSTALL) -d -m 755 $(DESTDIR)$(etcdir)
	test -f $(DESTDIR)$(etcdir)/pce.cfg || $(INSTALL) -m 644 pce.cfg $(DESTDIR)$(etcdir)


pce: $(OBJ) $(OBJ_EXT)
	$(LD) $(LD_FLG) -o $@ $(OBJ) $(OBJ_EXT) $(LD_FLG_EXTRA)

pce.cfg: pce.cfg.in
	sed -e "s]PCE_DIR_DATA]$(datdir)]g" < $< > $@


int13.o:	int13.c $(SDP)
ems.o:		ems.c $(SDP)
hook.o:		hook.c $(SDP)
ibmpc.o:	ibmpc.c $(SDP)
mouse.o:	mouse.c $(SDP)
parport.o:	parport.c $(SDP)
pce.o:		pce.c $(SDP)
xms.o:		xms.c $(SDP)
